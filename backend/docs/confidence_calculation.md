# 置信度计算系统

## 概述

置信度计算系统用于评估查询答案的可靠性，基于多个维度的分析给出高（high）、中（medium）、低（low）三个等级的置信度评估。

## 计算因素

### 1. 引用质量（权重: 30%）

评估答案引用的来源质量和相关性。

**子因素：**
- **引用数量**（0-0.5分）
  - ≥5条引用: 0.5分
  - 3-4条引用: 0.4分
  - 1-2条引用: 0.3分
  - 0条引用: 0分

- **引用相关性**（0-0.5分）
  - 基于重排序后的chunk相关性分数
  - 取前5个chunk的平均分数
  - 归一化到0-0.5范围

### 2. 答案质量（权重: 25%）

评估答案的完整性和结构。

**子因素：**
- **长度适中性**（0-0.6分）
  - 100-1000字: 0.6分（理想）
  - 50-100字: 0.4分（较短）
  - 1000-2000字: 0.5分（较长）
  - <50字: 0.2分（过短）
  - >2000字: 0.3分（过长）

- **结构完整性**（0-0.4分）
  - 有多个段落: +0.2分
  - 有结论性语句: +0.2分
    - 关键词：总之、综上、因此、所以、综合...来看等

### 3. 检索召回率（权重: 20%）

评估检索系统的效果。

**子因素：**
- **检索数量**（0-0.6分）
  - ≥20条: 0.6分
  - 10-19条: 0.5分
  - 5-9条: 0.4分
  - <5条: 0.3分

- **引用率**（0-0.4分）
  - 引用率 = 引用数 / 检索数
  - ≥30%: 0.4分
  - 20-29%: 0.3分
  - 10-19%: 0.2分
  - <10%: 0.1分

### 4. 语言确定性（权重: 25%）

评估答案表述的明确性。

**评分规则：**
- 基础分: 1.0分

**减分项：**
- **不确定词**（每个-0.1，最多-0.5）
  - 可能、也许、大概、似乎、好像、应该
  - 或许、估计、猜测、不确定、不清楚、未知

- **模糊词**（每个-0.05，最多-0.3）
  - 一些、某些、若干、多个、少量、大量
  - 很多、不少、较多、较少

**加分项：**
- **明确性表达**（+0.1）
  - 确实、明确、清楚、显然、毫无疑问
  - 事实上、实际上、具体来说

## 置信度等级

根据综合得分百分比划分：

| 等级 | 得分范围 | 说明 |
|-----|---------|-----|
| **HIGH** | ≥75% | 答案高度可靠，有充足引用支持，表述明确 |
| **MEDIUM** | 50-74% | 答案基本可靠，有一定引用支持，表述较清晰 |
| **LOW** | <50% | 答案可信度较低，引用不足或表述不够明确 |

## 计算公式

```
总分 = 引用质量 × 3.0 + 答案质量 × 2.5 + 检索召回率 × 2.0 + 语言确定性 × 2.5
最大分 = 10.0
置信度百分比 = (总分 / 最大分) × 100%
```

## 使用方式

### 非流式查询

自动计算置信度并包含在响应中：

```python
# 后端自动调用
from app.services.confidence_calculator import get_confidence_calculator

confidence_calculator = get_confidence_calculator()
confidence_level = confidence_calculator.calculate_confidence(
    answer=answer,
    citations=citations,
    reranked_chunks=reranked_chunks,
    retrieved_count=retrieved_count
)
```

### 流式查询

通过Self-RAG的矛盾检测和修正计算置信度：

- 初始置信度: `high`
- 检测到高置信度矛盾 → 降为 `low`
- 检测到中等置信度矛盾 → 降为 `medium`
- 低置信度矛盾 → 仅警告，不调整

## 调试信息

启用DEBUG日志可查看详细的置信度计算过程：

```python
logger.info(f"📊 置信度计算: {confidence_level.value} (得分: {percentage:.1f}%)")
logger.debug(f"   - 引用质量: {citation_score:.2f}")
logger.debug(f"   - 答案质量: {answer_quality_score:.2f}")
logger.debug(f"   - 检索效果: {retrieval_score:.2f}")
logger.debug(f"   - 语言确定性: {certainty_score:.2f}")
```

## 示例

### 高置信度示例

```
答案: "张九是为什么带张霞去参加斗剑？\n\n张九是带张霞（小七）参加天台山斗剑的原因是多层次的..."
引用数: 5条
平均相关性: 0.85
检索数: 30条
不确定词: 0个

结果: HIGH (78%)
```

### 中等置信度示例

```
答案: "根据小说内容，张九是可能带张霞去参加斗剑，因为..."
引用数: 2条
平均相关性: 0.65
检索数: 15条
不确定词: 1个（"可能"）

结果: MEDIUM (58%)
```

### 低置信度示例

```
答案: "不太清楚具体原因，也许是因为某些情节需要..."
引用数: 1条
平均相关性: 0.45
检索数: 8条
不确定词: 3个（"不太清楚"、"也许"、"某些"）

结果: LOW (42%)
```

## 优化建议

1. **提高引用质量**：优化检索和重排序算法
2. **改进答案生成**：使用更好的prompt工程
3. **减少不确定表述**：在prompt中要求明确回答
4. **增加检索深度**：提高初始检索的top-k值

## 未来改进

1. 结合模型输出的logprobs计算确定性
2. 引入用户反馈作为置信度调整因子
3. 基于历史准确率动态调整权重
4. 支持自定义权重配置

