openapi: 3.1.0
info:
  title: 网络小说智能问答系统 API
  description: |
    基于RAG架构的网络小说智能问答系统后端API。
    支持小说管理、智能问答、知识图谱可视化、Token统计等功能。
  version: 1.0.0
  contact:
    name: Development Team
    email: dev@novel-qa.com

servers:
  - url: http://localhost:8000/api
    description: 本地开发环境（推荐）
  - url: http://localhost:8000
    description: 本地开发环境（不带前缀，已废弃）

tags:
  - name: novels
    description: 小说管理
  - name: chapters
    description: 章节阅读
  - name: query
    description: 智能问答
  - name: graph
    description: 可视化
  - name: config
    description: 配置管理
  - name: stats
    description: 统计分析

paths:
  # ==================== 小说管理 ====================
  /novels/upload:
    post:
      tags: [novels]
      summary: 上传小说
      description: 上传TXT或EPUB格式的小说文件，开始索引构建
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file, title]
              properties:
                file:
                  type: string
                  format: binary
                  description: 小说文件（TXT/EPUB）
                title:
                  type: string
                  minLength: 1
                  maxLength: 200
                  description: 小说标题
                author:
                  type: string
                  maxLength: 100
                  description: 作者名称（可选）
      responses:
        '200':
          description: 上传成功，返回小说ID
          content:
            application/json:
              schema:
                type: object
                properties:
                  novelId:
                    type: integer
                  status:
                    type: string
                    enum: [processing]
                  message:
                    type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /novels:
    get:
      tags: [novels]
      summary: 获取小说列表
      description: 分页获取已上传的小说列表
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
            minimum: 1
        - name: pageSize
          in: query
          schema:
            type: integer
            default: 10
            minimum: 1
            maximum: 100
        - name: status
          in: query
          description: 按索引状态过滤
          schema:
            type: string
            enum: [pending, processing, completed, failed]
      responses:
        '200':
          description: 成功返回小说列表
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/NovelSummary'
                  total:
                    type: integer
                  page:
                    type: integer
                  pageSize:
                    type: integer

  /novels/{novelId}:
    get:
      tags: [novels]
      summary: 获取小说详情
      parameters:
        - $ref: '#/components/parameters/NovelId'
      responses:
        '200':
          description: 成功返回小说详情
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NovelDetail'
        '404':
          $ref: '#/components/responses/NotFound'
    
    delete:
      tags: [novels]
      summary: 删除小说
      description: 删除小说及其所有索引数据（向量、图谱、元数据）
      parameters:
        - $ref: '#/components/parameters/NovelId'
      responses:
        '200':
          description: 删除成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '404':
          $ref: '#/components/responses/NotFound'

  /novels/{novelId}/progress:
    get:
      tags: [novels]
      summary: 获取索引进度
      description: 实时获取小说索引构建进度（轮询使用，推荐使用WebSocket）
      parameters:
        - $ref: '#/components/parameters/NovelId'
      responses:
        '200':
          description: 成功返回进度信息
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IndexProgress'

  # ==================== 章节阅读 ====================
  /novels/{novelId}/chapters:
    get:
      tags: [chapters]
      summary: 获取章节列表
      parameters:
        - $ref: '#/components/parameters/NovelId'
      responses:
        '200':
          description: 成功返回章节列表
          content:
            application/json:
              schema:
                type: object
                properties:
                  chapters:
                    type: array
                    items:
                      $ref: '#/components/schemas/ChapterListItem'
                  total:
                    type: integer

  /novels/{novelId}/chapters/{chapterNum}:
    get:
      tags: [chapters]
      summary: 获取章节内容
      parameters:
        - $ref: '#/components/parameters/NovelId'
        - name: chapterNum
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
      responses:
        '200':
          description: 成功返回章节内容
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChapterContent'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== 智能问答 ====================
  /query:
    post:
      tags: [query]
      summary: 提交查询（非流式）
      description: 提交问题并等待完整结果返回。推荐使用WebSocket流式接口获得更好体验。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryRequest'
      responses:
        '200':
          description: 成功返回查询结果
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          description: 小说不存在或未索引完成
        '500':
          $ref: '#/components/responses/InternalError'

  /query/history:
    get:
      tags: [query]
      summary: 获取查询历史
      parameters:
        - name: novelId
          in: query
          schema:
            type: integer
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: pageSize
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
      responses:
        '200':
          description: 成功返回查询历史
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/QueryHistoryItem'
                  total:
                    type: integer
                  page:
                    type: integer
                  pageSize:
                    type: integer

  /query/{queryId}:
    get:
      tags: [query]
      summary: 获取单次查询详情
      parameters:
        - name: queryId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: 成功返回查询详情
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  /query/{queryId}/feedback:
    post:
      tags: [query]
      summary: 提交用户反馈
      parameters:
        - name: queryId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [feedback]
              properties:
                feedback:
                  type: string
                  enum: [positive, negative]
                note:
                  type: string
                  maxLength: 500
      responses:
        '200':
          description: 反馈提交成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  # ==================== 可视化 ====================
  /graph/relations/{novelId}:
    get:
      tags: [graph]
      summary: 获取角色关系图数据
      parameters:
        - $ref: '#/components/parameters/NovelId'
        - name: startChapter
          in: query
          schema:
            type: integer
          description: 起始章节（可选，用于查看特定章节范围的关系）
        - name: endChapter
          in: query
          schema:
            type: integer
          description: 结束章节（可选）
      responses:
        '200':
          description: 成功返回关系图数据
          content:
            application/json:
              schema:
                type: object
                properties:
                  nodes:
                    type: array
                    items:
                      $ref: '#/components/schemas/GraphNode'
                  edges:
                    type: array
                    items:
                      $ref: '#/components/schemas/GraphEdge'

  /graph/relations/{novelId}/node/{nodeId}:
    get:
      tags: [graph]
      summary: 获取节点详细信息
      parameters:
        - name: novelId
          in: path
          required: true
          schema:
            type: integer
          description: 小说ID
        - name: nodeId
          in: path
          required: true
          schema:
            type: string
          description: 节点ID（实体名称）
      responses:
        '200':
          description: 节点详细信息
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  name:
                    type: string
                  type:
                    type: string
                  attributes:
                    type: object
                  neighbors:
                    type: array
                    items:
                      type: object
        '404':
          $ref: '#/components/responses/NotFound'

  /graph/timeline/{novelId}:
    get:
      tags: [graph]
      summary: 获取时间线数据
      parameters:
        - $ref: '#/components/parameters/NovelId'
      responses:
        '200':
          description: 成功返回时间线数据
          content:
            application/json:
              schema:
                type: object
                properties:
                  events:
                    type: array
                    items:
                      $ref: '#/components/schemas/TimelineEvent'

  /graph/statistics/{novelId}:
    get:
      tags: [graph]
      summary: 获取统计数据
      parameters:
        - $ref: '#/components/parameters/NovelId'
      responses:
        '200':
          description: 成功返回统计数据
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Statistics'

  # ==================== 配置管理 ====================
  /config/models:
    get:
      tags: [config]
      summary: 获取支持的模型列表
      description: 返回所有支持的智谱AI模型及其配置信息
      responses:
        '200':
          description: 模型列表
          content:
            application/json:
              schema:
                type: object
                properties:
                  models:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                        category:
                          type: string
                        max_tokens:
                          type: integer
                        price_input:
                          type: number
                        price_output:
                          type: number
                        description:
                          type: string
                        is_default:
                          type: boolean
                  default_model:
                    type: string

  /config/current:
    get:
      tags: [config]
      summary: 获取当前配置
      description: 返回当前系统配置（脱敏处理）
      responses:
        '200':
          description: 当前配置
          content:
            application/json:
              schema:
                type: object
                properties:
                  api_key:
                    type: string
                    description: 脱敏的API Key
                  default_model:
                    type: string
                  supported_models_count:
                    type: integer
                  max_tokens_per_query:
                    type: integer
                  max_context_chunks:
                    type: integer
                  chunk_size:
                    type: integer
                  chunk_overlap:
                    type: integer
                  top_k_retrieval:
                    type: integer
                  top_k_rerank:
                    type: integer

  /config/test-connection:
    post:
      tags: [config]
      summary: 测试智谱AI连接
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [apiKey]
              properties:
                apiKey:
                  type: string
                  description: 智谱AI API Key
      responses:
        '200':
          description: 连接测试结果
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  model_tested:
                    type: string

  /config:
    get:
      tags: [config]
      summary: 获取系统配置
      responses:
        '200':
          description: 成功返回配置
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemConfig'
    
    put:
      tags: [config]
      summary: 更新系统配置
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SystemConfig'
      responses:
        '200':
          description: 配置更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  # ==================== 统计分析 ====================
  /stats/tokens:
    get:
      tags: [stats]
      summary: 获取Token统计
      parameters:
        - name: period
          in: query
          schema:
            type: string
            enum: [day, week, month, year]
            default: month
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: 成功返回Token统计
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenStatsReport'

  /stats/tokens/trend:
    get:
      tags: [stats]
      summary: 获取Token使用趋势
      description: 按时间段分组统计Token使用量，用于绘制趋势图
      parameters:
        - name: period
          in: query
          schema:
            type: string
            enum: [day, week, month]
            default: day
          description: 时间段类型
        - name: limit
          in: query
          schema:
            type: integer
            default: 30
            minimum: 1
            maximum: 365
          description: 返回数据点数量
      responses:
        '200':
          description: 趋势数据
          content:
            application/json:
              schema:
                type: object
                properties:
                  period:
                    type: string
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        date:
                          type: string
                        total_tokens:
                          type: integer
                        query_count:
                          type: integer

  /stats/tokens/summary:
    get:
      tags: [stats]
      summary: 获取Token统计摘要
      description: 快速获取关键统计数据，用于仪表盘展示
      responses:
        '200':
          description: 统计摘要
          content:
            application/json:
              schema:
                type: object
                properties:
                  all_time:
                    type: object
                    properties:
                      total_tokens:
                        type: integer
                      total_cost:
                        type: number
                  last_24h:
                    type: object
                    properties:
                      total_tokens:
                        type: integer
                      total_cost:
                        type: number
                  last_7d:
                    type: object
                    properties:
                      total_tokens:
                        type: integer
                      total_cost:
                        type: number
                  last_30d:
                    type: object
                    properties:
                      total_tokens:
                        type: integer
                      total_cost:
                        type: number

  /stats/tokens/operation/{operationId}:
    get:
      tags: [stats]
      summary: 获取单次操作Token详情
      parameters:
        - name: operationId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: 成功返回Token详情
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OperationTokenDetail'

  # ==================== Health Check ====================
  /health:
    get:
      tags: [system]
      summary: 健康检查
      responses:
        '200':
          description: 系统正常
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ok"
                  timestamp:
                    type: string
                    format: date-time

# ==================== WebSocket定义 ====================
x-websockets:
  /ws/progress/{novelId}:
    description: 小说索引进度推送
    messages:
      - name: progress
        payload:
          type: object
          properties:
            type:
              type: string
              const: progress
            progress:
              type: number
              minimum: 0
              maximum: 1
            task:
              type: string
      - name: complete
        payload:
          type: object
          properties:
            type:
              type: string
              const: complete
            novelId:
              type: integer
      - name: error
        payload:
          type: object
          properties:
            type:
              type: string
              const: error
            message:
              type: string

  /api/query/stream:
    description: 智能问答流式响应
    send:
      - name: query_request
        payload:
          $ref: '#/components/schemas/QueryRequest'
    receive:
      - name: stage_start
        payload:
          type: object
          properties:
            type:
              type: string
              const: stage_start
            stage:
              type: string
              enum: [understanding, retrieving, generating, validating, finalizing]
              description: 查询处理阶段
      - name: stage_complete
        payload:
          type: object
          properties:
            type:
              type: string
              const: stage_complete
            stage:
              type: string
            data:
              type: object
      - name: stream_token
        payload:
          type: object
          properties:
            type:
              type: string
              const: stream_token
            token:
              type: string
      - name: query_complete
        payload:
          type: object
          properties:
            type:
              type: string
              const: query_complete
            data:
              $ref: '#/components/schemas/QueryResponse'
      - name: error
        payload:
          type: object
          properties:
            type:
              type: string
              const: error
            error:
              type: string

# ==================== 组件定义 ====================
components:
  parameters:
    NovelId:
      name: novelId
      in: path
      required: true
      schema:
        type: integer
        minimum: 1
      description: 小说ID

  responses:
    BadRequest:
      description: 请求参数错误
      content:
        application/json:
          schema:
            type: object
            properties:
              detail:
                type: string
    
    NotFound:
      description: 资源不存在
      content:
        application/json:
          schema:
            type: object
            properties:
              detail:
                type: string
    
    InternalError:
      description: 服务器内部错误
      content:
        application/json:
          schema:
            type: object
            properties:
              detail:
                type: string

  schemas:
    # ========== 小说相关 ==========
    NovelSummary:
      type: object
      properties:
        id:
          type: integer
        title:
          type: string
        author:
          type: string
          nullable: true
        totalChapters:
          type: integer
        totalChars:
          type: integer
        indexStatus:
          type: string
          enum: [pending, processing, completed, failed]
        indexProgress:
          type: number
          minimum: 0
          maximum: 1
        uploadDate:
          type: string
          format: date-time

    NovelDetail:
      allOf:
        - $ref: '#/components/schemas/NovelSummary'
        - type: object
          properties:
            totalChunks:
              type: integer
            totalEntities:
              type: integer
            totalRelations:
              type: integer
            embeddingTokens:
              type: integer
            indexedDate:
              type: string
              format: date-time
              nullable: true

    IndexProgress:
      type: object
      properties:
        progress:
          type: number
          minimum: 0
          maximum: 1
        currentTask:
          type: string
          enum: [分块中, 向量化中, 构建图谱中]
        status:
          type: string
          enum: [processing, completed, failed]
        processedChunks:
          type: integer
        totalChunks:
          type: integer
        currentTokens:
          type: integer
        eta:
          type: integer
          description: 预计剩余秒数

    # ========== 章节相关 ==========
    ChapterListItem:
      type: object
      properties:
        num:
          type: integer
        title:
          type: string
          nullable: true
        charCount:
          type: integer

    ChapterContent:
      type: object
      properties:
        chapterNum:
          type: integer
        title:
          type: string
          nullable: true
        content:
          type: string
        prevChapter:
          type: integer
          nullable: true
        nextChapter:
          type: integer
          nullable: true
        totalChapters:
          type: integer

    # ========== 查询相关 ==========
    QueryRequest:
      type: object
      required: [novelId, query]
      properties:
        novelId:
          type: integer
        query:
          type: string
          minLength: 1
          maxLength: 1000
        model:
          type: string
          enum: [GLM-4.5-Flash, GLM-4.5, GLM-4-Plus, GLM-4-Long, GLM-4.6]
          default: GLM-4.5
          description: 智谱AI模型名称（官方名称）

    Citation:
      type: object
      properties:
        chapter_num:
          type: integer
          description: 章节号
        chapter_title:
          type: string
          nullable: true
          description: 章节标题
        text:
          type: string
          description: 引用文本
        score:
          type: number
          nullable: true
          description: 相关性分数

    Contradiction:
      type: object
      properties:
        type:
          type: string
          description: 矛盾类型
        early_description:
          type: string
          description: 早期描述
        early_chapter:
          type: integer
          description: 早期章节
        late_description:
          type: string
          description: 后期描述
        late_chapter:
          type: integer
          description: 后期章节
        analysis:
          type: string
          description: 矛盾分析
        confidence:
          type: string
          enum: [high, medium, low]
          description: 置信度

    TokenStats:
      type: object
      properties:
        total_tokens:
          type: integer
          description: 总Token数
        embedding_tokens:
          type: integer
          default: 0
          description: Embedding消耗的Token
        prompt_tokens:
          type: integer
          default: 0
          description: 提示词Token数
        completion_tokens:
          type: integer
          default: 0
          description: 生成内容Token数
        self_rag_tokens:
          type: integer
          default: 0
          description: Self-RAG验证额外消耗的Token
        by_model:
          type: object
          description: 按模型分类的Token统计
          additionalProperties:
            type: object
            properties:
              input_tokens:
                type: integer
              prompt_tokens:
                type: integer
              completion_tokens:
                type: integer
              total_tokens:
                type: integer

    QueryResponse:
      type: object
      properties:
        queryId:
          type: integer
        answer:
          type: string
        citations:
          type: array
          items:
            $ref: '#/components/schemas/Citation'
        graphInfo:
          type: object
          nullable: true
          properties:
            entities:
              type: array
              items:
                type: string
            relations:
              type: array
              items:
                type: object
                properties:
                  source:
                    type: string
                  target:
                    type: string
                  type:
                    type: string
        contradictions:
          type: array
          items:
            $ref: '#/components/schemas/Contradiction'
        tokenStats:
          $ref: '#/components/schemas/TokenStats'
        responseTime:
          type: number
        confidence:
          type: string
          enum: [high, medium, low]
        model:
          type: string
        timestamp:
          type: string
          format: date-time

    QueryHistoryItem:
      type: object
      properties:
        id:
          type: integer
        novelId:
          type: integer
        query:
          type: string
        answer:
          type: string
          description: 简短摘要（前100字）
        model:
          type: string
        totalTokens:
          type: integer
        confidence:
          type: string
        createdAt:
          type: string
          format: date-time
        feedback:
          type: string
          enum: [positive, negative]
          nullable: true

    # ========== 图谱相关 ==========
    GraphNode:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        type:
          type: string
          enum: [character, location, organization, item]
        importance:
          type: number
          minimum: 0
          maximum: 1

    GraphEdge:
      type: object
      properties:
        source:
          type: string
        target:
          type: string
        relationType:
          type: string
        startChapter:
          type: integer
        endChapter:
          type: integer
          nullable: true

    TimelineEvent:
      type: object
      properties:
        chapterNum:
          type: integer
        narrativeOrder:
          type: integer
        actualTime:
          type: string
        description:
          type: string

    Statistics:
      type: object
      properties:
        totalChars:
          type: integer
        totalChapters:
          type: integer
        characterCount:
          type: integer
        relationCount:
          type: integer
        averageChapterLength:
          type: number

    # ========== 配置相关 ==========
    SystemConfig:
      type: object
      properties:
        defaultModel:
          type: string
          enum: [glm-4-flash, glm-4, glm-4-plus, glm-4-5, glm-4-6]
        topK:
          type: integer
          minimum: 10
          maximum: 50
          default: 30
        chunkSize:
          type: integer
          minimum: 400
          maximum: 800
          default: 550
        chunkOverlap:
          type: integer
          minimum: 50
          maximum: 200
          default: 125
        enableSelfRAG:
          type: boolean
          default: true
        enableSmartRouting:
          type: boolean
          default: true

    # ========== 统计相关 ==========
    TokenStatsReport:
      type: object
      properties:
        totalTokens:
          type: integer
        queryCount:
          type: integer
        indexCount:
          type: integer
        averageTokensPerQuery:
          type: integer
        byModel:
          type: object
          additionalProperties:
            type: object
            properties:
              totalTokens:
                type: integer
              promptTokens:
                type: integer
              completionTokens:
                type: integer
              apiCalls:
                type: integer
        byOperation:
          type: object
          properties:
            index:
              type: object
              properties:
                totalTokens:
                  type: integer
                count:
                  type: integer
            query:
              type: object
              properties:
                totalTokens:
                  type: integer
                count:
                  type: integer
        dailyStats:
          type: array
          items:
            type: object
            properties:
              date:
                type: string
                format: date
              totalTokens:
                type: integer
              queryCount:
                type: integer

    OperationTokenDetail:
      type: object
      properties:
        operationId:
          type: integer
        operationType:
          type: string
          enum: [query, index]
        timestamp:
          type: string
          format: date-time
        tokenStats:
          $ref: '#/components/schemas/TokenStats'

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: JWT认证（可选，个人应用可不启用）

# 默认不启用安全认证（个人应用）
# security:
#   - BearerAuth: []

